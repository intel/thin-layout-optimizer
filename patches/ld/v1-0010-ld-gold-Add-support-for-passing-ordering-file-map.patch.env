From 7f3b88bc375b5ed1b96299e77700de8d3e52eb7f Mon Sep 17 00:00:00 2001
From: Noah Goldstein <goldstein.w.n@gmail.com>
Date: Mon, 22 Apr 2024 19:54:01 -0500
Subject: ld/gold: Add support for passing ordering file/map via env variables

---
 gold/parameters.cc                |  4 ++--
 include/ld-and-gold-env-scripts.h | 29 ++++++++++++++++++++++++++++-
 ld/lexsup.c                       |  5 +++--
 3 files changed, 33 insertions(+), 5 deletions(-)

diff --git a/gold/parameters.cc b/gold/parameters.cc
index 193a057a31e..b8849034ad8 100644
--- a/gold/parameters.cc
+++ b/gold/parameters.cc
@@ -244,8 +244,8 @@ Parameters::set_section_ordering_file_from_map()
 
   // Read filepath from environment.
   ret = ld_and_gold_get_ordering_script (
-      0, this->options ().section_ordering_file (),
-      this->options ().section_ordering_map (),
+      0, "GOLD_ORDERING_SCRIPT", this->options ().section_ordering_file (),
+      "GOLD_ORDERING_SCRIPT_MAP", this->options ().section_ordering_map (),
       this->options ().output_file_name (),
       parameters->target_valid () ? parameters->target ().machine_code_name ()
 				  : NULL);
diff --git a/include/ld-and-gold-env-scripts.h b/include/ld-and-gold-env-scripts.h
index 5018e98437f..699df6beca3 100644
--- a/include/ld-and-gold-env-scripts.h
+++ b/include/ld-and-gold-env-scripts.h
@@ -365,7 +365,9 @@ ld_and_gold_get_ordering_script_from_map (const char *output_dso,
  * env variable and 2. a map of DSO -> scripts if env variable (1) doesn't
  * exist. Only takes affect if normal commandline arguments not present. */
 static char *
-ld_and_gold_get_ordering_script (int is_ld, const char *file_linker_script_in,
+ld_and_gold_get_ordering_script (int is_ld, const char *env_linker_script_in,
+				 const char *file_linker_script_in,
+				 const char *env_linker_script_map_in,
 				 const char *file_linker_script_map_in,
 				 const char *output_dso,
 				 const char *target_name)
@@ -380,6 +382,31 @@ ld_and_gold_get_ordering_script (int is_ld, const char *file_linker_script_in,
       linker_script = ld_and_gold_get_ordering_script_from_map (
 	  output_dso, target_name, file_linker_script_map_in);
     }
+  else
+    {
+      char *linker_script_map = NULL;
+      if (env_linker_script_in != NULL)
+	{
+	  linker_script = getenv (env_linker_script_in);
+	}
+
+      if (linker_script == NULL || access (linker_script, F_OK) != 0)
+	{
+	  if (env_linker_script_map_in == NULL)
+	    {
+	      return NULL;
+	    }
+
+	  linker_script_map = getenv (env_linker_script_map_in);
+	  if (linker_script_map == NULL)
+	    {
+	      return NULL;
+	    }
+
+	  linker_script = ld_and_gold_get_ordering_script_from_map (
+	      output_dso, target_name, linker_script_map);
+	}
+    }
 
   if (linker_script == NULL)
     {
diff --git a/ld/lexsup.c b/ld/lexsup.c
index 8e15ed3514f..676c1c373c3 100644
--- a/ld/lexsup.c
+++ b/ld/lexsup.c
@@ -811,8 +811,9 @@ parse_args (unsigned argc, char **argv)
 	{
 	  char *ordering_script = NULL;
 	  ordering_script = ld_and_gold_get_ordering_script (
-	      1, config.text_section_ordering_file, text_section_ordering_map,
-	      output_dso, ldemul_emulation_name ());
+	      1, "LD_ORDERING_SCRIPT", config.text_section_ordering_file,
+	      "LD_ORDERING_SCRIPT_MAP", text_section_ordering_map, output_dso,
+	      ldemul_emulation_name ());
 
 	  if (verbose)
 	    info_msg ("Using ordering script: %s\n\tArg: %s\n\tMap: %s\n",
-- 
2.34.1

